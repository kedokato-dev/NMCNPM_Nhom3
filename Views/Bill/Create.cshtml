@model NMCNPM_Nhom3.Models.Entities.TblBill

@{
    ViewData["Title"] = "T·∫°o H√≥a ƒê∆°n";
}

<div class="container mt-4">
    <h2 class="text-primary text-center">T·∫°o H√≥a ƒê∆°n</h2>
    <hr>

    <!-- Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng ho·∫∑c l·ªói -->
    <div id="messageContainer"></div> <!-- Div ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o -->

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body">
                    <form id="billForm">
                        <!-- CCCD -->
                        <div class="mb-3">
                            <label for="customerIdCard" class="form-label fw-bold">S·ªë CCCD</label>
                            <input type="text" class="form-control" id="customerIdCard" name="customerIdCard" required maxlength="12" />
                            <small class="text-danger d-none" id="cccdError">S·ªë CCCD kh√¥ng h·ª£p l·ªá!</small>
                        </div>

                        <!-- Th√¥ng tin kh√°ch h√†ng -->
                        <div id="customerInfo" class="d-none">
                            <div class="mb-3">
                                <label for="customerName" class="form-label fw-bold">üë§ H·ªç t√™n kh√°ch h√†ng</label>
                                <input type="text" class="form-control" id="customerName" name="customerName" required />
                                <small class="text-danger d-none" id="nameError">H·ªç t√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª± ch·ªØ c√°i!</small>
                            </div>

                            <div class="mb-3">
                                <label for="customerPhone" class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng</label>
                                <input type="text" class="form-control" id="customerPhone" name="customerPhone" required />
                                <small class="text-danger d-none" id="phoneError">S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 ho·∫∑c 11 ch·ªØ s·ªë!</small>
                            </div>

                            <button type="button" class="btn btn-primary w-100 rounded-pill" id="nextStepBtn">‚û° Ti·∫øp theo</button>
                        </div>

                        <!-- Th√¥ng tin h√≥a ƒë∆°n (·∫®n ban ƒë·∫ßu) -->
                        <div id="billDetails" class="d-none">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Th·ªùi gian b·∫Øt ƒë·∫ßu</label>
                                <input type="datetime-local" class="form-control" id="startTime" name="DBeginTime" value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" required />
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Th·ªùi gian k·∫øt th√∫c</label>
                                <input type="datetime-local" class="form-control" id="endTime" name="DEndTime" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Tr·∫°ng th√°i thu√™</label>
                                <select class="form-control" name="IStatus">
                                    <option value="1">ƒêang thu√™</option>
                                    <option value="0">Tr·ªëng</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Nh√¢n vi√™n t·∫°o</label>
                                <input type="text" class="form-control" id="staffName" name="staffName" value="@User.Identity.Name" readonly style="background-color: #f0f0f0;"/>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Ph√≠ ph√°t sinh</label>
                                <input type="number" class="form-control" name="FIncidentalCosts" step="0.1" />
                            </div>

                            <!-- M√£ xe -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Nh·∫≠p m√£ xe</label>
                                <input type="number" class="form-control" id="bikeCode" name="bikeCode" />
                            </div>

                            <!-- Hi·ªÉn th·ªã th√¥ng tin xe -->
                            <div id="bikeInfo" class="d-none border p-3 mt-3">
                                <h5>Th√¥ng tin xe</h5>
                                <div><strong>T√™n xe:</strong> <span id="bikeName"></span></div>
                                <div><strong>Tr·∫°ng th√°i:</strong> <span id="bikeStatus"></span></div>
                                <div><strong>ƒêi·ªÅu ki·ªán xe:</strong> <span id="bikeCondition"></span></div>
                                <div><strong>Gi√° thu√™:</strong> <span id="bikeRentalPrice"></span></div>
                                <img id="bikeImage" src="@Url.Content("~/assets/resources/@Model.SImage")" class="img-fluid mt-2" alt="Bike Image" />

                                <button type="button" class="btn btn-success mt-2" id="addBikeBtn">Th√™m xe</button>
                            </div>

                            <!-- Danh s√°ch xe ƒë√£ ch·ªçn -->
                            <div id="selectedBikes" class="mt-3"></div>

                            <button type="button" id="submitBillBtn" class="btn btn-primary w-100 mt-3 rounded-pill">T·∫°o H√≥a ƒê∆°n</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Ki·ªÉm tra CCCD realtime
        $('#customerIdCard').on('input', function () {
            var cccd = $(this).val().trim();
            if (/^\d{12}$/.test(cccd)) {
                $.ajax({
                    url: '@Url.Action("SearchCustomer", "Bill")',
                    type: 'GET',
                    data: { customerIdCard: cccd },
                    success: function (response) {
                        if (response.success) {
                            $('#customerName').val(response.customerName);
                            $('#customerPhone').val(response.customerPhone);
                        } else {
                            $('#customerName').val('');
                            $('#customerPhone').val('');
                        }
                        $('#customerInfo').removeClass('d-none');
                    }
                });
            } else {
                $('#customerInfo').addClass('d-none');
            }
        });

        // T·ª± ƒë·ªông t√≠nh to√°n th·ªùi gian k·∫øt th√∫c (DEndTime) khi trang ƒë∆∞·ª£c load
        var startTime = new Date($('#startTime').val());
        startTime.setHours(startTime.getHours() + 3);  // C·ªông th√™m 3 gi·ªù v√†o th·ªùi gian b·∫Øt ƒë·∫ßu

        // C·∫≠p nh·∫≠t gi√° tr·ªã 'endTime' v·ªõi ƒë·ªãnh d·∫°ng dd/MM/yyyy h:mm
        var formattedEndTime = (startTime.getDate() < 10 ? '0' + startTime.getDate() : startTime.getDate()) + '/' +
            (startTime.getMonth() + 1 < 10 ? '0' + (startTime.getMonth() + 1) : (startTime.getMonth() + 1)) + '/' +
            startTime.getFullYear().toString().slice(2) + ' ' +
            (startTime.getHours() < 10 ? '0' + startTime.getHours() : startTime.getHours()) + ':' +
            (startTime.getMinutes() < 10 ? '0' + startTime.getMinutes() : startTime.getMinutes());

        $('#endTime').val(formattedEndTime);

        // Ki·ªÉm tra v√† ƒë·∫£m b·∫£o th·ªùi gian k·∫øt th√∫c (DEndTime) l·ªõn h∆°n th·ªùi gian b·∫Øt ƒë·∫ßu √≠t nh·∫•t 3 gi·ªù khi ng∆∞·ªùi d√πng thay ƒë·ªïi th·ªùi gian b·∫Øt ƒë·∫ßu
        $('#startTime').on('change', function () {
            var startTime = new Date($(this).val());
            var endTime = new Date($('#endTime').val());

            // ƒê·∫£m b·∫£o endTime lu√¥n l·ªõn h∆°n startTime √≠t nh·∫•t 3 gi·ªù
            if (endTime <= startTime) {
                startTime.setHours(startTime.getHours() + 3);  // C·ªông th√™m 3 gi·ªù
                var formattedEndTime = (startTime.getDate() < 10 ? '0' + startTime.getDate() : startTime.getDate()) + '/' +
                    (startTime.getMonth() + 1 < 10 ? '0' + (startTime.getMonth() + 1) : (startTime.getMonth() + 1)) + '/' +
                    startTime.getFullYear().toString().slice(2) + ' ' +
                    (startTime.getHours() < 10 ? '0' + startTime.getHours() : startTime.getHours()) + ':' +
                    (startTime.getMinutes() < 10 ? '0' + startTime.getMinutes() : startTime.getMinutes());
                $('#endTime').val(formattedEndTime);
            }
        });

        // Ki·ªÉm tra v√† ƒë·∫£m b·∫£o th·ªùi gian k·∫øt th√∫c (DEndTime) l·ªõn h∆°n th·ªùi gian b·∫Øt ƒë·∫ßu √≠t nh·∫•t 3 gi·ªù khi ng∆∞·ªùi d√πng thay ƒë·ªïi endTime
        $('#endTime').on('change', function () {
            var startTime = new Date($('#startTime').val());
            var endTime = new Date($(this).val());

            // N·∫øu th·ªùi gian k·∫øt th√∫c nh·ªè h∆°n ho·∫∑c b·∫±ng th·ªùi gian b·∫Øt ƒë·∫ßu, c·∫≠p nh·∫≠t th·ªùi gian k·∫øt th√∫c
            if (endTime <= startTime) {
                startTime.setHours(startTime.getHours() + 3);  // C·ªông th√™m 3 gi·ªù
                var formattedEndTime = (startTime.getDate() < 10 ? '0' + startTime.getDate() : startTime.getDate()) + '/' +
                    (startTime.getMonth() + 1 < 10 ? '0' + (startTime.getMonth() + 1) : (startTime.getMonth() + 1)) + '/' +
                    startTime.getFullYear().toString().slice(2) + ' ' +
                    (startTime.getHours() < 10 ? '0' + startTime.getHours() : startTime.getHours()) + ':' +
                    (startTime.getMinutes() < 10 ? '0' + startTime.getMinutes() : startTime.getMinutes());
                $('#endTime').val(formattedEndTime);
            }
        });

        // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i realtime
        $('#customerPhone').on('input', function () {
            var phone = $(this).val().trim();
            if (!/^\d{10,11}$/.test(phone)) {
                $('#phoneError').removeClass('d-none'); // Hi·ªÉn th·ªã l·ªói
            } else {
                $('#phoneError').addClass('d-none'); // ·∫®n l·ªói
            }
        });

        // Ki·ªÉm tra h·ªç t√™n realtime
        $('#customerName').on('input', function () {
            var name = $(this).val().trim();
            if (!/^[A-Za-z√Ä-·ªπ\s]{2,}$/.test(name)) {
                $('#nameError').removeClass('d-none'); // Hi·ªÉn th·ªã l·ªói
            } else {
                $('#nameError').addClass('d-none'); // ·∫®n l·ªói
            }
        });

        // Nh·∫•n ti·∫øp theo ƒë·ªÉ hi·ªán form ti·∫øp theo
        $('#nextStepBtn').click(function () {
            if ($('#phoneError').hasClass('d-none') && $('#nameError').hasClass('d-none')) {
                $('#billDetails').removeClass('d-none');
            } else {
                alert("Vui l√≤ng nh·∫≠p th√¥ng tin h·ª£p l·ªá tr∆∞·ªõc khi ti·∫øp t·ª•c!");
            }
        });

        // T√¨m ki·∫øm xe
        $('#bikeCode').on('input', function () {
            var bikeCode = $(this).val().trim();
            if (bikeCode !== '') {
                setTimeout(function () {
                    $.ajax({
                        url: '@Url.Action("SearchBike", "Bill")',
                        type: 'GET',
                        data: { bikeCode: bikeCode },
                        success: function (response) {
                            if (response.success) {
                                $('#bikeName').text(response.bikeName);
                                $('#bikeStatus').text(response.bikeStatus);
                                $('#bikeCondition').text(response.bikeCondition);
                                $('#bikeRentalPrice').text(response.bikeRentalPrice);
                                $('#bikeImage').attr('src', response.bikeImage);
                                $('#bikeInfo').removeClass('d-none');
                            } else {
                                $('#bikeInfo').addClass('d-none');
                            }
                        }
                    });
                }, 2000);
            }
        });

        // Th√™m xe v√†o danh s√°ch
        $('#addBikeBtn').click(function () {
            var bikeName = $('#bikeName').text();
            var bikeId = $('#bikeCode').val();
            var bikeInfo = `<div class="p-2 border rounded mt-2">
                        <strong>${bikeName}</strong> - M√£: ${bikeId}
                        <button class="btn btn-danger btn-sm ms-2 removeBike">X√≥a</button>
                    </div>`;
            $('#selectedBikes').append(bikeInfo);
            $('#bikeInfo').addClass('d-none');
            $('#bikeCode').val('');
        });

        // X√≥a xe kh·ªèi danh s√°ch
        $(document).on('click', '.removeBike', function () {
            $(this).parent().remove();
        });

        // G·ª≠i y√™u c·∫ßu t·∫°o h√≥a ƒë∆°n
        $('#submitBillBtn').click(function (e) {
            e.preventDefault();  // Ng·ª´ng t·∫£i l·∫°i trang
            var billData = $('#billForm').serialize(); // L·∫•y d·ªØ li·ªáu t·ª´ form

            $.ajax({
                url: '@Url.Action("Create", "Bill")',
                type: 'POST',
                data: billData,
                success: function (response) {
                    if (response.success) {
                        $('#messageContainer').html('<div class="alert alert-success">' + response.message + '</div>');
                    } else {
                        $('#messageContainer').html('<div class="alert alert-danger">' + response.message + '</div>');
                    }
                },
                error: function () {
                    $('#messageContainer').html('<div class="alert alert-danger">C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i sau.</div>');
                }
            });
        });
    });


</script>
